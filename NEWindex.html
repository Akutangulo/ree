<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Precio de la luz por hora en Espa√±a a trav√©s de la API de Red El√©ctrica Espa√±ola</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚ö°</text></svg>"><!-- favicon -->
    <link href="./../1estilosNEW.css" rel="stylesheet" type="text/css">
</head>
<style>
    body {
        display: flex;
        flex-wrap: wrap;
        align-items: flex-start;
        justify-content: center;
        font-size: calc(16px + (24 - 16) * ((100vw - 320px) / (1920 - 320))); /* formula para hacer el texto responsive, hay que comprobarlo con chat GTP */
        text-align: center;
        font-family: 'Roboto', "Helvetica", "Arial", sans-serif;
    }

    .contenedor {
        flex: 1; /* La columna izquierda ocupa el espacio disponible */
        max-width: 75%; /* Ajustar el ancho m√°ximo seg√∫n las necesidades */
        padding: 10px;
    }

    .contenedor div div {
        border-radius: 8px;
        
        padding: 10px;
        margin: 5px;
    }

    .publicidad {
        flex: 1; /* La columna derecha ocupa el espacio disponible */
        border: 1px solid #ddd;
    }

    .publicidad-lateral {
        flex: 1; /* La columna derecha en dispositivos peque√±os */
        padding: 10px;
        max-width: 10%;
        border: 1px solid #ddd;
        
        writing-mode: vertical-rl; /* orientacion vertical de la escritura ¬øtambien del contenido?*/
        text-orientation: upright; /*√âsta propiedad s√≥lo tiene efecto cuando writing-mode este en modo vertical */
    }

    .precio1, .precio2, .precio3, .precio4, .precio5, .precio6, .precio7, .precio8, .precio9, .precio10, .precio11, .precio12, .precio13, .precio14, .precio15, .precio16, .precio17, .precio18, .precio19, .precio20, .precio21, .precio22, .precio23, .precio24 {
        border-style: solid;
        border-color: black;
        font-size: 1.2em;
    }

    .precio1 {
        background-color: #77dd77;
        font-size: 1.4em;
    }

    .precio2, .precio3, .precio4, .precio5, .precio6, .precio7, .precio8 {
        background-color: #b0f2c2;
    }

    .precio23, .precio22, .precio21, .precio20, .precio19, .precio18, .precio17 {
        background-color: #fcb7af;
    }

    .precio24 {
        background-color: #ff6961;
                color: #fff;
    }

    #precioActual {
        font-size: 1.8rem;
        border: 2px solid #0ea0d1;
    }
    #reloj {
     color: darkviolet;
    }

    .precioPasado {
    background-color: #c5c6c8;
    font-size: 0.8rem;
    }

.informacionDiaria {
  --borderWidth: 5px;
  position: relative;
  font-size: 1.5em;
  color: #fff;
}

.informacionDiaria:after {
  content: '';
  position: absolute;
  top: calc(-1 * var(--borderWidth));
  left: calc(-1 * var(--borderWidth));
  height: calc(100% + var(--borderWidth) * 2);
  width: calc(100% + var(--borderWidth) * 2);
  background: linear-gradient(60deg, #f79533, #f37055, #ef4e7b, #a166ab, #5073b8, #1098ad, #07b39b, #6fba82);
  border-radius: calc(2 * var(--borderWidth));
  z-index: -1;
  animation: animatedgradient 4s ease alternate infinite;
  background-size: 300% 300%;
}

@keyframes animatedgradient {
  0% {background-position: 0% 50%;}
  50% {background-position: 100% 50%;}
  100% {background-position: 0% 50%;}
}

    .precioLuzBarato {
        text-shadow: 1px 1px 2px green;
    }
    .precioLuzCaro {
        text-shadow: 1px 1px 2px red;
    }
    .precioMedioLuz {
        text-shadow: 1px 1px 2px blue;
    }


</style>

<body>
    <div class="contenedor">
        <div id="electricity-container-today">
            <h2>Precios de Electricidad - Hoy</h2>
            <!-- Agregar el div informacionDiaria para "Hoy" -->
            <div class="informacionDiaria"></div>          
        </div>
        <div class="publicidad">Espacio para publicidad</div>
        <div id="electricity-container-tomorrow">
            <h2>Precios de Electricidad - Ma√±ana</h2>
            <!-- Agregar el div informacionDiaria para "Ma√±ana" -->
            <div class="informacionDiaria"></div>               
        </div>
    </div>
    <div class="publicidad-lateral">Espacio lateral para publicidad</div>  
</body>
    <script>
        // Obtener la fecha actual
        const currentDate = new Date();

        // Obtener la fecha de ma√±ana
        const tomorrowDate = new Date(currentDate);
        tomorrowDate.setDate(currentDate.getDate() + 1);

        // Formatear las fechas en el formato necesario (YYYY-MM-DDTHH:mm) -> ISO 8601
        const startDate = formatDate(currentDate) + "T00:00";
        const endDate = formatDate(tomorrowDate) + "T23:59";

        // Construir la URL de la API con las fechas din√°micas en formato ISO 8601
        const apiUrl = `https://apidatos.ree.es/es/datos/mercados/precios-mercados-tiempo-real?start_date=${startDate}&end_date=${endDate}&time_trunc=hour`;
    console.log("üñ¥ URL de la API de REE:", apiUrl); // Mostrar la URL de la API de Red El√©ctrica Espa√±ola en la consola de la web app

        // Funci√≥n para formatear la fecha en el formato YYYY-MM-DD
        function formatDate(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, "0");
            const day = date.getDate().toString().padStart(2, "0");
            return `${year}-${month}-${day}`;
        }

        // Obtener los contenedores donde se mostrar√°n los precios de hoy y ma√±ana
        const containerToday = document.getElementById('electricity-container-today');
        const containerTomorrow = document.getElementById('electricity-container-tomorrow');

        // Obtener los divs de informaci√≥n diaria
        const infoToday = document.querySelector('.informacionDiaria');
        const infoTomorrow = document.querySelectorAll('.informacionDiaria')[1];

        // Obtener los datos de la API
        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                // Obtener los datos de los precios de electricidad
                const pricesData = data.included.find(item => item.type === 'PVPC (\u20ac/MWh)').attributes.values;

                // Obtener la hora actual
                const currentHour = new Date().getHours();

                // Calcular las clases basadas en el precio para "Hoy"
                const priceValuesToday = pricesData.filter(item => new Date(item.datetime).getDate() === currentDate.getDate()).map(item => item.value);
                const priceClassesToday = priceValuesToday.slice().sort((a, b) => a - b).reduce((acc, val, idx) => {
                    acc[val] = `precio${idx + 1}`;
                    return acc;
                }, {});

                // Calcular las clases basadas en el precio para "Ma√±ana"
                const priceValuesTomorrow = pricesData.filter(item => new Date(item.datetime).getDate() === tomorrowDate.getDate()).map(item => item.value);
                const priceClassesTomorrow = priceValuesTomorrow.slice().sort((a, b) => a - b).reduce((acc, val, idx) => {
                    acc[val] = `precio${idx + 1}`;
                    return acc;
                }, {});

                // Recorrer los datos y agregar divs al contenedor correspondiente
                pricesData.forEach((item, index) => {
                    const datetime = new Date(item.datetime);
                    const price = item.value.toFixed(2);
                    const div = document.createElement('div');

                    // Agregar clase "precioPasado" si la hora ya ha pasado
                    if (index < currentHour) {
                        div.classList.add('precioPasado');
                    }

                    // Calcular la clase basada en el precio actual para "Hoy"
                    if (priceClassesToday[item.value]) {
                        div.classList.add(priceClassesToday[item.value]);
                    }

                    // Calcular la clase basada en el precio actual para "Ma√±ana"
                    if (priceClassesTomorrow[item.value]) {
                        div.classList.add(priceClassesTomorrow[item.value]);
                    }

                    // Crear elementos span para mostrar la hora y el precio
                    const timeSpan = document.createElement('span');
                    if (index === currentHour) {
                        const clockSpan = document.createElement('span');
                        clockSpan.id = 'reloj';
                        timeSpan.appendChild(clockSpan);
                        div.id = 'precioActual'; // Agrega el id 'precioActual' al div de la hora actual
                        updateClock(); // Llama a updateClock inmediatamente para mostrar la hora actual
                        setInterval(updateClock, 1000); // Actualiza el reloj cada segundo
                    } else {
                        timeSpan.innerHTML = getCurrentTime(datetime);
                    }

                    const priceSpan = document.createElement('span');
                    priceSpan.innerHTML = (price / 1000).toFixed(3) + ' ‚Ç¨ por Kilovatio';

                    // Agregar los elementos span al div
                    div.appendChild(timeSpan);
                    div.appendChild(document.createElement('br'));
                    div.appendChild(priceSpan);

                    // Agregar el div al contenedor correspondiente
                    if (new Date(item.datetime).getDate() === currentDate.getDate()) {
                        containerToday.appendChild(div);
                    } else {
                        containerTomorrow.appendChild(div);
                    }
                });
                
                 // Calcular el precio medio del d√≠a para "Hoy" y "Ma√±ana"
                 const avgPriceToday = calculateAveragePrice(pricesData, currentDate);
                const avgPriceTomorrow = calculateAveragePrice(pricesData, tomorrowDate);

                // Calcular el precio m√°s caro y m√°s barato para "Hoy" y "Ma√±ana"
                const maxMinToday = calculateMaxMinPrice(pricesData, currentDate);
                const maxMinTomorrow = calculateMaxMinPrice(pricesData, tomorrowDate);

                // Formatear la fecha en el formato deseado
                const formattedCurrentDate = formatDateInCustomFormat(currentDate);
                const formattedTomorrowDate = formatDateInCustomFormat(tomorrowDate);

                // Mostrar la informaci√≥n en los divs de informaci√≥n diaria
                infoToday.innerHTML = `<span class="precioMedioLuz">El precio medio de la luz hoy ${formattedCurrentDate} es ${avgPriceToday} ‚Ç¨</span>` +
                    `<br><span class="precioLuzBarato">Precio m√°s barato hoy: ${maxMinToday.minPrice} ‚Ç¨ a las ${maxMinToday.minHour}</span>` +
                    `<br><span class="precioLuzCaro">Precio m√°s caro hoy: ${maxMinToday.maxPrice} ‚Ç¨ a las ${maxMinToday.maxHour}</span>`;

                infoTomorrow.innerHTML = `El precio medio de la luz ma√±ana ${formattedTomorrowDate} es ${avgPriceTomorrow} ‚Ç¨` +
                    `<br><span class="precioLuzBarato">Precio m√°s barato ma√±ana: ${maxMinTomorrow.minPrice} ‚Ç¨ a las ${maxMinTomorrow.minHour}</span>` +
                    `<br><span class="precioLuzCaro">Precio m√°s caro ma√±ana: ${maxMinTomorrow.maxPrice} ‚Ç¨ a las ${maxMinTomorrow.maxHour}</span>`;

            })
            .catch(error => console.log('Error:', error));

        // Funci√≥n para obtener la hora actual en formato HH:00
        function getCurrentTime(date) {
            const formattedHours = date.getHours().toString().padStart(2, '0');
            return `${formattedHours}:00`;
        }

        // Funci√≥n para calcular el precio medio del d√≠a
        function calculateAveragePrice(prices, targetDate) {
            const pricesForDate = prices.filter(item => new Date(item.datetime).getDate() === targetDate.getDate());
            const sum = pricesForDate.reduce((total, item) => total + item.value, 0);
            return (sum / pricesForDate.length / 1000).toFixed(2);
        }

        // Funci√≥n para calcular el precio m√°s caro y m√°s barato del d√≠a
        function calculateMaxMinPrice(prices, targetDate) {
            const pricesForDate = prices.filter(item => new Date(item.datetime).getDate() === targetDate.getDate());

            if (pricesForDate.length === 0) {
                return {
                    minPrice: 0,
                    minHour: 'N/A',
                    maxPrice: 0,
                    maxHour: 'N/A'
                };
            }

            const sortedPrices = pricesForDate.map(item => ({
                price: item.value,
                hour: new Date(item.datetime).getHours(),
            })).sort((a, b) => a.price - b.price);

            const minPrice = (sortedPrices[0].price / 1000).toFixed(2);
            const minHour = `${sortedPrices[0].hour}:00`;
            const maxPrice = (sortedPrices[sortedPrices.length - 1].price / 1000).toFixed(2);
            const maxHour = `${sortedPrices[sortedPrices.length - 1].hour}:00`;

            return {
                minPrice,
                minHour,
                maxPrice,
                maxHour,
            };
        }

        // Funci√≥n para actualizar el reloj cada segundo
        function updateClock() {
            const clockElement = document.getElementById('reloj');
            if (clockElement) {
                const currentTime = new Date();
                const formattedTime = currentTime.getHours().toString().padStart(2, '0') + ':' +
                    currentTime.getMinutes().toString().padStart(2, '0') + ':' +
                    currentTime.getSeconds().toString().padStart(2, '0');
                clockElement.textContent = formattedTime;
            };
        }

        // Funci√≥n para formatear la fecha en el formato deseado
        function formatDateInCustomFormat(date) {
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            };
            return date.toLocaleDateString('es-ES', options);
        }
    </script>

</html>
