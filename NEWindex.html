<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>PRECIOS ELECTRICIDAD</title>
    <link href="./estilosNEW.css" rel="stylesheet" type="text/css">
</head>
<style>
    div {
      border-style: solid;
      border-color: black;
    }
    span {
      border-color: rgb(194, 22, 22);
      border-style: solid;
    }
    #precioActual {
        font-size: 2em;
    }
    .precioPasado {
        background-color: lightgray;
    }
    .precio1 {
        background-color: rgb(48, 231, 79);
    }
    .precio24 {
        background-color: rgb(231, 48, 48);
    }
    .precioLuzBarato {
    color: green;
    }
    .precioLuzCaro {
        color: red;
    }
    .precioMedioLuz {
    color: blue;
    }
  </style>
<body>
    <div class="contenedor">
        <div>
            <div class="informacionDiaria" id="info-today"></div>
            <h2>Precios de Electricidad - Hoy</h2>
            <div id="electricity-container-today"></div>
        </div>

        <div>
            <div class="informacionDiaria" id="info-tomorrow"></div>
            <h2>Precios de Electricidad - Mañana</h2>
            <div id="electricity-container-tomorrow"></div>
        </div>
    </div>
</body>

    <script>
        // Obtener la fecha actual
        const currentDate = new Date();

        // Obtener la fecha de mañana
        const tomorrowDate = new Date(currentDate);
        tomorrowDate.setDate(currentDate.getDate() + 1);

        // Formatear las fechas en el formato necesario (YYYY-MM-DDTHH:mm) -> ISO 8601
        const startDate = formatDate(currentDate) + "T00:00";
        const endDate = formatDate(tomorrowDate) + "T23:59";

        // Construir la URL de la API con las fechas dinámicas en formato ISO 8601
        const apiUrl = `https://apidatos.ree.es/es/datos/mercados/precios-mercados-tiempo-real?start_date=${startDate}&end_date=${endDate}&time_trunc=hour`;

        // Función para formatear la fecha en el formato YYYY-MM-DD 
        function formatDate(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, "0");
            const day = date.getDate().toString().padStart(2, "0");
            return `${year}-${month}-${day}`;
        }

        // Obtener los contenedores donde se mostrarán los precios de hoy y mañana
        const containerToday = document.getElementById('electricity-container-today');
        const containerTomorrow = document.getElementById('electricity-container-tomorrow');

        // Obtener los divs de información diaria
        const infoToday = document.getElementById('info-today');
        const infoTomorrow = document.getElementById('info-tomorrow');

        // Obtener los datos de la API
        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                // Obtener los datos de los precios de electricidad
                const pricesData = data.included.find(item => item.type === 'PVPC (\u20ac/MWh)').attributes.values;

                // Obtener la hora actual
                const currentHour = new Date().getHours();

                // Calcular las clases basadas en el precio para "Hoy"
                const priceValuesToday = pricesData.filter(item => new Date(item.datetime).getDate() === currentDate.getDate()).map(item => item.value);
                const priceClassesToday = priceValuesToday.slice().sort((a, b) => a - b).reduce((acc, val, idx) => {
                    acc[val] = `precio${idx + 1}`;
                    return acc;
                }, {});

                // Calcular las clases basadas en el precio para "Mañana"
                const priceValuesTomorrow = pricesData.filter(item => new Date(item.datetime).getDate() === tomorrowDate.getDate()).map(item => item.value);
                const priceClassesTomorrow = priceValuesTomorrow.slice().sort((a, b) => a - b).reduce((acc, val, idx) => {
                    acc[val] = `precio${idx + 1}`;
                    return acc;
                }, {});

                // Calcular el precio medio, precio más caro y más barato para "Hoy" y "Mañana"
                const avgPriceToday = calculateAveragePrice(priceValuesToday);
                const avgPriceTomorrow = calculateAveragePrice(priceValuesTomorrow);
                const maxMinToday = calculateMaxMinPrice(pricesData, currentDate);
                const maxMinTomorrow = calculateMaxMinPrice(pricesData, tomorrowDate);

                // Mostrar la información de "Hoy" en el div correspondiente
                infoToday.innerHTML = `<span class="precioMedioLuz">El precio medio de la luz hoy ${formatDateInCustomFormat(currentDate)} es ${avgPriceToday} €</span><br>` +
                    `<span class="precioLuzBarato">Precio más barato hoy: ${maxMinToday.minPrice} € a las ${maxMinToday.minHour}</span><br>` +
                    `<span class="precioLuzCaro">Precio más caro hoy: ${maxMinToday.maxPrice} € a las ${maxMinToday.maxHour}</span>`;

                // Mostrar la información de "Mañana" en el div correspondiente
                infoTomorrow.innerHTML = `<span class="precioMedioLuz">El precio medio de la luz mañana ${formatDateInCustomFormat(tomorrowDate)} es ${avgPriceTomorrow} €</span><br>` +
                    `<span class="precioLuzBarato">Precio más barato mañana: ${maxMinTomorrow.minPrice} € a las ${maxMinTomorrow.minHour}</span><br>` +
                    `<span class="precioLuzCaro">Precio más caro mañana: ${maxMinTomorrow.maxPrice} € a las ${maxMinTomorrow.maxHour}</span>`;

                // Recorrer los datos y agregar divs al contenedor correspondiente
                pricesData.forEach((item, index) => {
                    const datetime = new Date(item.datetime);
                    const price = item.value.toFixed(2);
                    const div = document.createElement('div');

                    // Agregar clase "precioPasado" si la hora ya ha pasado
                    if (index < currentHour) {
                        div.classList.add('precioPasado');
                    }

                    // Calcular la clase basada en el precio actual para "Hoy"
                    if (priceClassesToday[item.value]) {
                        div.classList.add(priceClassesToday[item.value]);
                    }

                    // Calcular la clase basada en el precio actual para "Mañana"
                    if (priceClassesTomorrow[item.value]) {
                        div.classList.add(priceClassesTomorrow[item.value]);
                    }

                    // Crear elementos span para mostrar la hora y el precio
                    const timeSpan = document.createElement('span');
                    if (index === currentHour) {
                        const clockSpan = document.createElement('span');
                        clockSpan.id = 'reloj';
                        timeSpan.appendChild(clockSpan);
                        div.id = 'precioActual'; // Agrega el id 'precioActual' al div de la hora actual
                        updateClock(); // Llama a updateClock inmediatamente para mostrar la hora actual
                        setInterval(updateClock, 1000); // Actualiza el reloj cada segundo
                    } else {
                        timeSpan.innerHTML = getCurrentTime(datetime);
                    }

                    const priceSpan = document.createElement('span');
                    priceSpan.innerHTML = (price / 1000).toFixed(3) + ' € por Kilovatio';

                    // Agregar los elementos span al div
                    div.appendChild(timeSpan);
                    div.appendChild(document.createElement('br'));
                    div.appendChild(priceSpan);

                    // Agregar el div al contenedor correspondiente
                    if (new Date(item.datetime).getDate() === currentDate.getDate()) {
                        containerToday.appendChild(div);
                    } else {
                        containerTomorrow.appendChild(div);
                    }
                });
            })
            .catch(error => console.log('Error:', error));

        // Función para obtener la hora actual en formato HH:00
        function getCurrentTime(date) {
            const formattedHours = date.getHours().toString().padStart(2, '0');
            return `${formattedHours}:00`;
        }

        // Función para calcular el precio medio del día
        function calculateAveragePrice(prices) {
            const sum = prices.reduce((total, price) => total + price, 0);
            return (sum / prices.length / 1000).toFixed(3);
        }

        // Función para calcular el precio más caro y más barato del día
        function calculateMaxMinPrice(prices, targetDate) {
            const dayPrices = prices.filter(item => new Date(item.datetime).getDate() === targetDate.getDate());
            const sortedPrices = dayPrices.slice().sort((a, b) => b.value - a.value);
            const maxPrice = (sortedPrices[0].value / 1000).toFixed(3);
            const minPrice = (sortedPrices[sortedPrices.length - 1].value / 1000).toFixed(3);
            const maxHour = getCurrentTime(new Date(sortedPrices[0].datetime));
            const minHour = getCurrentTime(new Date(sortedPrices[sortedPrices.length - 1].datetime));
            return { maxPrice, maxHour, minPrice, minHour };
        }

        // Función para actualizar el reloj cada segundo
        function updateClock() {
            const clockElement = document.getElementById('reloj');
            if (clockElement) {
                const currentTime = new Date();
                const formattedTime = currentTime.getHours().toString().padStart(2, '0') + ':' +
                    currentTime.getMinutes().toString().padStart(2, '0') + ':' +
                    currentTime.getSeconds().toString().padStart(2, '0');
                clockElement.textContent = formattedTime;
            }
        }

        // Función para formatear la fecha en el formato deseado
        function formatDateInCustomFormat(date) {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('es-ES', options);
        }
    </script>
</html>
