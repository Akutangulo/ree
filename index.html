<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚡</text></svg>"><!-- favicon -->

    <title>Precio de la luz por hora en España a través de la API de Red Eléctrica Española</title>
    
</head>
<body>
    <div id="electricity-container"></div>
    <div id="informacion-diaria" class="informacionDiaria"></div>
    <a href="https://akutangulo.com" target="_blank" rel="noopener" title="Akutangulo.com">Akutangulo.com</a>
</body>

<script>
  // Obtener la fecha actual
var currentDate = new Date();

// Obtener la fecha de mañana
var tomorrowDate = new Date();
tomorrowDate.setDate(currentDate.getDate() + 1);

// Formatear las fechas en el formato necesario (YYYY-MM-DDTHH:mm) ISO 8601
var startDate = formatDate(currentDate) + "T00:00";
var endDate = formatDate(tomorrowDate) + "T23:59";

// Construir la URL de la API con las fechas dinámicas
var apiUrl = "https://apidatos.ree.es/es/datos/mercados/precios-mercados-tiempo-real?start_date=" + startDate + "&end_date=" + endDate + "&time_trunc=hour";

// Función para formatear la fecha en el formato YYYY-MM-DD
function formatDate(date) {
  var year = date.getFullYear();
  var month = (date.getMonth() + 1).toString().padStart(2, "0");
  var day = date.getDate().toString().padStart(2, "0");
  return year + "-" + month + "-" + day;
}

// Obtener el contenedor donde se mostrarán los precios
var container = document.getElementById('electricity-container');
var infoContainer = document.getElementById('informacion-diaria');

// Obtener los datos de la API
fetch(apiUrl)
  .then(response => response.json())
  .then(data => {
    // Obtener los datos de los precios de electricidad
    var pricesData = data.included.find(item => item.type === 'PVPC (\u20ac/MWh)').attributes.values;

    // Obtener la hora actual
    var currentHour = new Date().getHours();

    // Recorrer los datos y agregar divs al contenedor
    pricesData.forEach(function(item, index) {
      var datetime = new Date(item.datetime);
      var price = item.value.toFixed(2);
      var div = document.createElement('div');

      // Agregar las clases correspondientes según las condiciones
      if (index === currentHour) {
        div.classList.add('precioActual');
      } else if (price === getLowestPrice(pricesData)) {
        div.classList.add('mejorPrecio');
      } else if (price === getHighestPrice(pricesData)) {
        div.classList.add('peorPrecio');
      } else if (datetime < new Date()) {
        div.classList.add('precioPasado');
      }

      // Crear elementos span para mostrar la hora y el precio
      var timeSpan = document.createElement('span');
      if (index === currentHour) {
        var clockSpan = document.createElement('span');
        clockSpan.id = 'clock';
        timeSpan.appendChild(clockSpan);
      } else {
        timeSpan.innerHTML  = getCurrentTime(datetime);
      }
      
      var priceSpan = document.createElement('span');
      priceSpan.innerHTML = (price / 1000).toFixed(3) + ' € por Kilovatio';
      
      // Agregar los elementos span al div y el div al contenedor
      div.appendChild(timeSpan);
      div.appendChild(document.createElement('br'));
      div.appendChild(priceSpan);
      container.appendChild(div);
    });

    // Obtener el precio medio del día
    var dailyPrice = getAveragePrice(pricesData).toFixed(2);

    // Obtener el día de la semana en formato "Domingo 18 de Junio"
    var formattedDate = new Date(pricesData[0].datetime);
    var formattedDateString = getFormattedDateString(formattedDate);

    // Crear elementos para mostrar la información diaria
    var infoText = document.createElement('div');
    infoText.textContent = `El precio medio de la luz hoy ${formattedDateString} es ${dailyPrice} €`;

    var highestPriceText = document.createElement('span');
    highestPriceText.textContent = `Precio más alto: ${getHighestPrice(pricesData).toFixed(2)} €`;

    var lowestPriceText = document.createElement('span');
    lowestPriceText.textContent = `Precio más bajo: ${getLowestPrice(pricesData).toFixed(2)} €`;

    // Agregar los elementos al contenedor de información diaria
    infoContainer.appendChild(infoText);
    infoContainer.appendChild(document.createElement('br'));
    infoContainer.appendChild(highestPriceText);
    infoContainer.appendChild(document.createElement('br'));
    infoContainer.appendChild(lowestPriceText);

    // Actualizar el reloj cada segundo
    setInterval(updateClock, 1000);
  })
  .catch(error => console.log('Error:', error));

// Función para obtener la hora actual en formato HH:00
function getCurrentTime(date) {
  var formattedHours = date.getHours().toString().padStart(2, '0');
  return `${formattedHours}:00`;
}

// Función para actualizar el reloj cada segundo
function updateClock() {
  var clockElement = document.getElementById('clock');
  if (clockElement) {
    var currentTime = new Date();
    var formattedTime = currentTime.getHours().toString().padStart(2, '0') + ':' +
                        currentTime.getMinutes().toString().padStart(2, '0') + ':' +
                        currentTime.getSeconds().toString().padStart(2, '0');
    clockElement.textContent = formattedTime;
  }
}

// Función para obtener el precio más bajo
function getLowestPrice(pricesData) {
  var lowestPrice = Number.MAX_VALUE;
  pricesData.forEach(function(item) {
    var price = item.value;
    if (price < lowestPrice) {
      lowestPrice = price;
    }
  });
  return lowestPrice;
}

// Función para obtener el precio más alto
function getHighestPrice(pricesData) {
  var highestPrice = Number.MIN_VALUE;
  pricesData.forEach(function(item) {
    var price = item.value;
    if (price > highestPrice) {
      highestPrice = price;
    }
  });
  return highestPrice;
}

// Función para obtener el precio medio del día
function getAveragePrice(pricesData) {
  var sum = 0;
  pricesData.forEach(function(item) {
    sum += item.value;
  });
  return sum / pricesData.length;
}

// Función para obtener el día de la semana en formato "Domingo 18 de Junio"
function getFormattedDateString(date) {
  var daysOfWeek = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
  var monthsOfYear = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

  var dayOfWeek = daysOfWeek[date.getDay()];
  var dayOfMonth = date.getDate();
  var month = monthsOfYear[date.getMonth()];

  return `${dayOfWeek} ${dayOfMonth} de ${month}`;
}
</script>
</html>
